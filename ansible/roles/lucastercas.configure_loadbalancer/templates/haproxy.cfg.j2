#{{ ansible_managed }}

global
  user haproxy
  group haproxy

defaults
  mode http
  log global
  retries 2
  timeout connect 3000ms
  timeout server 5000ms
  timeout client 5000ms

frontend front_masters
  bind *:6443
  mode tcp
  option tcplog
  default_backend back_masters

frontend front_app
  bind *:80
  mode tcp
  default_backend back_app

frontend front_dashboard
  bind *:443
  mode tcp
  default_backend back_dashboard

backend back_masters
  mode tcp
  balance roundrobin
  option tcp-check
  {% for server in groups.control_nodes %}
  server {{ server }} {{ hostvars[server].ansible_host }}:6443 check fall 3 rise 2
  {% endfor %}

backend back_app
  mode tcp
  balance roundrobin
  option tcp-check
  {% for server in groups.worker_nodes %}
  server {{ server }} {{ hostvars[server].ansible_host }}:30045 check fall 3 rise 2
  {% endfor %}

backend back_dashboard
  mode tcp
  balance roundrobin
  option tcp-check
  {% for server in groups.worker_nodes %}
  server {{ server }} {{ hostvars[server].ansible_host }}:31506 check fall 3 rise 2
  {% endfor %}