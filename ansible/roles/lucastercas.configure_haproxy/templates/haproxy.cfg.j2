#{{ ansible_managed }}

global
  user haproxy
  group haproxy

defaults
  mode http
  log global
  retries 2
  timeout connect 3000ms
  timeout server 5000ms
  timeout client 5000ms

frontend kubernetes
  {% for host in groups['loadbalancers'] %}
  bind {{ hostvars[host]['ansible_host'] }}:6443
  {% endfor %}
  mode tcp
  option tcplog
  option forwardfor
  default_backend kubernetes-master-nodes

backend kubernetes-master-nodes
  mode tcp
  balance roundrobin
  option tcp-check
  {% for host in groups['control_nodes'] %}
  server {{ host }} {{ hostvars[host]['ansible_host'] }}:6443 check fall 3 rise 2
  {% endfor %}